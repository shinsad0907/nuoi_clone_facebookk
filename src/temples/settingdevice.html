<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Thi·∫øt b·ªã v√† ·ª®ng d·ª•ng TikTok</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .device-item,
      .app-item {
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .device-item:hover,
      .app-item:hover {
        background-color: #e5e7eb;
      }
      .selected {
        background-color: #bfdbfe;
      }
      .app-group {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
      }
      .toggle-apps {
        cursor: pointer;
        user-select: none;
      }
      .app-list {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .app-list.expanded {
        max-height: 1000px;
        transition: max-height 0.5s ease-in;
      }
      .account-info {
        cursor: pointer;
      }
      .account-info:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-4">
      <h1 class="text-2xl font-bold mb-4">
        Qu·∫£n l√Ω Thi·∫øt b·ªã v√† ·ª®ng d·ª•ng TikTok
      </h1>
      <div class="flex">
        <!-- Treeview -->
        <div
          class="w-1/3 bg-white shadow-md rounded-lg p-4 overflow-auto max-h-screen"
        >
          <h2 class="text-lg font-semibold mb-2">Thi·∫øt b·ªã v√† ·ª®ng d·ª•ng</h2>
          <div id="treeview" class="space-y-2"></div>
        </div>
        <!-- Chi ti·∫øt v√† H√†nh ƒë·ªông -->
        <div class="w-2/3 ml-4">
          <div id="details" class="bg-white shadow-md rounded-lg p-4 mb-4">
            <h2 class="text-lg font-semibold mb-2">Chi ti·∫øt</h2>
            <p id="detailContent">
              Ch·ªçn m·ªôt thi·∫øt b·ªã ho·∫∑c ·ª©ng d·ª•ng ƒë·ªÉ xem chi ti·∫øt.
            </p>
          </div>
          <div class="bg-white shadow-md rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-2">H√†nh ƒë·ªông</h2>
            <button
              id="addDeviceBtn"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"
            >
              Th√™m Thi·∫øt b·ªã
            </button>
            <button
              id="removeDeviceBtn"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 mr-2"
              disabled
            >
              X√≥a Thi·∫øt b·ªã
            </button>
            <button
              id="refreshBtn"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2"
            >
              L√†m m·ªõi ADB
            </button>
            <button
              id="createGroupBtn"
              class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600"
              disabled
            >
              T·∫°o Nh√≥m ·ª®ng d·ª•ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal ƒë·ªÉ ƒë·∫∑t t√™n cho nh√≥m t√†i kho·∫£n -->
    <div
      id="name_group"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center"
    >
      <div class="bg-white p-4 rounded-lg">
        <h2 class="text-lg font-semibold mb-2">T√™n Nh√≥m T√†i Kho·∫£n</h2>
        <input
          id="name_group_account"
          type="text"
          placeholder="T√™n nh√≥m t√†i kho·∫£n"
          class="w-full mb-2 p-2 border rounded"
        />

        <div class="flex justify-end">
          <button
            id="saveAccountBtn_name_group_account"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"
          >
            L∆∞u
          </button>
          <button
            id="closeModalBtn_name_group_account"
            class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <!-- Modal ƒë·ªÉ ch·ªânh s·ª≠a th√¥ng tin t√†i kho·∫£n -->
    <div
      id="accountModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center"
    >
      <div class="bg-white p-4 rounded-lg">
        <h2 class="text-lg font-semibold mb-2">Th√¥ng tin T√†i kho·∫£n</h2>
        <input
          id="accountUsername"
          type="text"
          placeholder="T√™n ƒëƒÉng nh·∫≠p"
          class="w-full mb-2 p-2 border rounded"
        />
        <input
          id="accountPassword"
          type="password"
          placeholder="M·∫≠t kh·∫©u"
          class="w-full mb-2 p-2 border rounded"
        />
        <input
          id="accountProxy"
          type="text"
          placeholder="Proxy (t√πy ch·ªçn)"
          class="w-full mb-2 p-2 border rounded"
        />
        <div class="flex justify-end">
          <button
            id="saveAccountBtn"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"
          >
            L∆∞u
          </button>
          <button
            id="closeModalBtn"
            class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // DOM elements
      const elements = {
        treeview: document.getElementById("treeview"),
        detailContent: document.getElementById("detailContent"),
        addDeviceBtn: document.getElementById("addDeviceBtn"),
        removeDeviceBtn: document.getElementById("removeDeviceBtn"),
        refreshBtn: document.getElementById("refreshBtn"),
        createGroupBtn: document.getElementById("createGroupBtn"),
        accountModal: document.getElementById("accountModal"),
        accountUsername: document.getElementById("accountUsername"),
        accountPassword: document.getElementById("accountPassword"),
        accountProxy: document.getElementById("accountProxy"),
        saveAccountBtn: document.getElementById("saveAccountBtn"),
        closeModalBtn: document.getElementById("closeModalBtn"),
        nameGroupModal: document.getElementById("name_group"),
        nameGroupAccount: document.getElementById("name_group_account"),
        saveNameGroup: document.getElementById(
          "saveAccountBtn_name_group_account"
        ),
      };

      // State variables
      let selectedNode,
        selectedDevice,
        selectedApp,
        currentEditingApp,
        devices = [],
        selectedApps = [];

      // Helper functions
      const createNode = (item, type) => {
        const node = document.createElement("div");
        node.className = `${type}-item pl-4 py-2 rounded flex items-center`;
        node.innerHTML = `
        <span class="mr-2">${type === "device" ? "üì±" : "üîπ"}</span>
        <span class="flex-grow">${item.name || item.device_name}</span>
        ${
          type === "app"
            ? '<input type="checkbox" class="app-checkbox mr-2">'
            : ""
        }
        ${type === "device" ? '<span class="toggle-apps mr-2">‚ñº</span>' : ""}
      `;

        if (type === "app") {
          const checkbox = node.querySelector(".app-checkbox");
          checkbox.onchange = (e) => {
            e.stopPropagation();
            toggleAppSelection(item, e.target.checked);
          };
        }

        node.onclick = (e) => {
          if (
            type === "device" ||
            (type === "app" && e.target !== node.querySelector(".app-checkbox"))
          ) {
            selectNode(node, item, type);
          }
        };

        return node;
      };

      const toggleAppSelection = (app, isSelected) => {
        selectedApps = isSelected
          ? [...selectedApps, app]
          : selectedApps.filter((a) => a.id !== app.id);
        elements.createGroupBtn.disabled = selectedApps.length < 1;
      };

      const selectNode = (node, item, type) => {
        if (selectedNode) selectedNode.classList.remove("selected");
        selectedNode = node;
        node.classList.add("selected");

        selectedDevice = type === "device" ? item : selectedDevice;
        selectedApp = type === "app" ? item : null;

        updateDetails(item, type);
        elements.removeDeviceBtn.disabled = type !== "device";
      };

      const updateDetails = (item, type) => {
        const details =
          type === "device"
            ? `
          <p><strong>ID:</strong> ${item.id}</p>
          <p><strong>Tr·∫°ng th√°i:</strong> ${item.status}</p>
        `
            : `
          <p><strong>Package:</strong> ${item.id}</p>
          <p><strong>Phi√™n b·∫£n:</strong> ${item.version || "Kh√¥ng x√°c ƒë·ªãnh"}</p>
          <p><strong>T√†i kho·∫£n:</strong> <span class="account-info" data-app-id="${
            item.id
          }">${
                item.account ? item.account.username : "Ch∆∞a c√≥ t√†i kho·∫£n"
              }</span></p>
        `;

        elements.detailContent.innerHTML = details;

        if (type === "app") {
          elements.detailContent
            .querySelector(".account-info")
            .addEventListener("dblclick", () => openAccountModal(item));
        }
      };

      const openAccountModal = (app) => {
        if (!selectedDevice) {
          alert("Vui l√≤ng ch·ªçn m·ªôt thi·∫øt b·ªã tr∆∞·ªõc khi ch·ªânh s·ª≠a t√†i kho·∫£n.");
          return;
        }

        elements.accountModal.classList.remove("hidden");
        elements.accountModal.classList.add("flex");

        Object.entries({
          "data-device-id": selectedDevice.id,
          "data-device-name": selectedDevice.device_name,
          "data-app-id": app.id,
          "data-app-name": app.name,
        }).forEach(([key, value]) =>
          elements.accountModal.setAttribute(key, value)
        );

        elements.accountUsername.value = app.account?.username || "";
        elements.accountPassword.value = app.account?.password || "";
        elements.accountProxy.value = app.account?.proxy || "";
      };

      const saveAccount = () => {
        const accountData = {
          username: elements.accountUsername.value,
          password: elements.accountPassword.value,
          proxy: elements.accountProxy.value,
        };

        const deviceId = elements.accountModal.getAttribute("data-device-id");
        const appId = elements.accountModal.getAttribute("data-app-id");

        // console.log("Th√¥ng tin t√†i kho·∫£n ƒë√£ l∆∞u:", {
        //   "T√™n m√°y": elements.accountModal.getAttribute("data-device-name"),
        //   "T√™n ·ª©ng d·ª•ng TikTok":
        //     elements.accountModal.getAttribute("data-app-name"),
        //   ...accountData,
        // });

        updateAppAccountInfo(appId, accountData);
        ipcRenderer.send("save_account", {
          name_device: elements.accountModal.getAttribute("data-device-name"),
          appId,
          accountData,
        });
        closeModal();
      };

      const closeModal = () => {
        elements.accountModal.classList.remove("flex");
        elements.accountModal.classList.add("hidden");
        [
          "data-device-id",
          "data-device-name",
          "data-app-id",
          "data-app-name",
        ].forEach((attr) => elements.accountModal.removeAttribute(attr));
      };

      const createDeviceNode = (device) => {
        const deviceNode = document.createElement("div");
        deviceNode.className = "device-container mb-2";
        deviceNode.innerHTML = `
        <div class="device-item pl-4 py-2 rounded flex items-center">
          <span class="mr-2">üì±</span>
          <span class="flex-grow">${device.device_name}</span>
          <span class="toggle-apps mr-2">‚ñº</span>
        </div>
        <div class="app-list ml-4" data-device-id="${device.id}"></div>
      `;

        const toggleApps = deviceNode.querySelector(".toggle-apps");
        const appList = deviceNode.querySelector(".app-list");

        toggleApps.onclick = (e) => {
          e.stopPropagation();
          appList.classList.toggle("expanded");
          toggleApps.textContent = appList.classList.contains("expanded")
            ? "‚ñ≤"
            : "‚ñº";
        };

        deviceNode.querySelector(".device-item").onclick = () =>
          selectNode(deviceNode, device, "device");

        return deviceNode;
      };

      // ... (c√°c h√†m kh√°c gi·ªØ nguy√™n)

      const updateDeviceList = (newDevices) => {
        devices = newDevices;
        elements.treeview.innerHTML = "";
        devices.forEach((device) => {
          const deviceNode = createDeviceNode(device);
          elements.treeview.appendChild(deviceNode);
        });
      };

      const updateAppList = (apps) => {
        const deviceId = devices[0].id;
        const appList = document.querySelector(
          `[data-device-id="${deviceId}"]`
        );
        if (appList) {
          appList.innerHTML = "";
          apps.forEach((app) => {
            const appNode = createNode(app, "app");
            appList.appendChild(appNode);
          });
        }
      };

      const updateAppAccountInfo = (appId, accountData) => {
        const accountInfo = document.querySelector(
          `.account-info[data-app-id="${appId}"]`
        );
        if (accountInfo)
          accountInfo.textContent = accountData.username || "Ch∆∞a c√≥ t√†i kho·∫£n";

        const appIndex = selectedApps.findIndex((app) => app.id === appId);
        if (appIndex !== -1) selectedApps[appIndex].account = accountData;
      };

      elements.saveNameGroup.onclick = () => {
        const nameGroup = elements.nameGroupAccount.value;
        const selectedAppsWithDeviceNames = selectedApps.map((app) => {
          const device = devices.find((d) => d.id === app.device_id);
          return {
            name_group: nameGroup,
            id: app.id,
            name: app.name,
            status: app.status || "Connected",
            device_name: device?.device_name,
            id_device: device?.device_id,
          };
        });
        elements.nameGroupModal.classList.add("hidden");
        console.log("C√°c ·ª©ng d·ª•ng ƒë√£ ch·ªçn:", selectedAppsWithDeviceNames);
        ipcRenderer.send("create_app_group", selectedAppsWithDeviceNames);
      };
      // Event listeners
      elements.addDeviceBtn.onclick = () => ipcRenderer.send("add_device");
      elements.removeDeviceBtn.onclick = () => {
        if (selectedNode?.classList.contains("device-item")) {
          ipcRenderer.send(
            "remove_device",
            selectedNode.querySelector(".flex-grow").textContent
          );
        }
      };
      elements.refreshBtn.onclick = () => ipcRenderer.send("get_devices");
      elements.createGroupBtn.onclick = () => {
        elements.nameGroupModal.classList.remove("hidden");
        console.log("create group");
      };
      elements.saveAccountBtn.onclick = saveAccount;
      elements.closeModalBtn.onclick = closeModal;

      // IPC listeners
      ipcRenderer.on("infomation_devices", (_, newDevices) => {
        if (newDevices) {
          console.log(
            "Danh s√°ch thi·∫øt b·ªã:",
            JSON.stringify(newDevices, null, 2)
          );
          updateDeviceList(newDevices);
          ipcRenderer.send("get_application_tiktok");
        } else {
          console.error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu JSON cho thi·∫øt b·ªã");
        }
      });

      ipcRenderer.on("get_application_tiktoks", (_, apps) => {
        if (apps) {
          console.log(
            "Danh s√°ch ·ª©ng d·ª•ng TikTok:",
            JSON.stringify(apps, null, 2)
          );
          updateAppList(apps);
        } else {
          console.error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu JSON cho ·ª©ng d·ª•ng TikTok");
        }
      });

      // Initialize
      ipcRenderer.send("get_devices");

      // Expose function to global scope
      window.editAccount = openAccountModal;
    </script>
  </body>
</html>
